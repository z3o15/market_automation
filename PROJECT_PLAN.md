# 市场自动化项目计划文档

## 项目概述

### 项目背景和目标

市场自动化项目最初基于传商精灵4.3u应用，采用Python + Frida + Lua三层架构实现装备市场的自动化操作和数据采集。现有系统通过Frida Hook技术拦截应用的网络请求和UI事件，结合Lua脚本实现自动化操作流程，最终由Python主程序进行整体控制和数据管理。

**项目目标**：
- 将现有基于Frida Hook的复杂架构简化为更稳定、更易维护的"按键精灵/ADB → 截图 → 本地存储"方案
- 提高系统的稳定性和可靠性，减少对应用版本更新的依赖
- 降低技术复杂度，提高开发和维护效率
- 保持现有功能的同时，增强反检测能力
- 优化数据处理流程，提高数据采集效率

### 新方案简介（按键精灵/ADB → 截图 → 本地存储）

新方案采用更直接、更稳定的自动化技术栈：

1. **按键精灵/ADB控制层**：
   - 使用按键精灵或ADB命令模拟用户操作
   - 实现点击、滑动、输入等基本交互
   - 提供更稳定的自动化控制机制

2. **截图识别层**：
   - 通过ADB截取设备屏幕
   - 使用图像识别技术分析界面元素
   - 识别装备信息、价格、按钮位置等关键数据

3. **本地存储层**：
   - 将采集的数据直接存储到本地数据库
   - 提供数据分析和统计功能
   - 支持数据导出和备份

### 项目范围和边界

**项目范围**：
- 重新设计自动化控制架构
- 实现截图和图像识别功能
- 开发本地数据存储系统
- 迁移现有配置和日志系统
- 保持与现有系统的数据兼容性

**项目边界**：
- 不修改目标应用的任何代码
- 不涉及服务器端API的直接调用
- 不改变现有的数据结构和格式
- 不影响用户现有的使用习惯

## 技术方案

### 核心技术架构

新方案采用两层架构设计，相比现有的三层架构更加简洁高效：

```
┌─────────────────────────────────────────────────────────────┐
│                    主控制层 (Python)                      │
│  • 自动化控制  • 图像识别  • 数据处理  • 配置管理        │
├─────────────────────────────────────────────────────────────┤
│                   设备交互层 (ADB/按键精灵)               │
│  • 屏幕截图  • 操作模拟  • 状态监控  • 错误恢复        │
├─────────────────────────────────────────────────────────────┤
│                   应用界面层 (Android)                     │
│  • 市场界面  • 装备数据  • 用户交互  • 界面渲染        │
└─────────────────────────────────────────────────────────────┘
```

### 技术选型说明

| 技术领域 | 现有方案 | 新方案 | 选型理由 |
|---------|---------|--------|---------|
| 自动化控制 | Frida Hook + Lua | 按键精灵/ADB | 更稳定，不易被检测，兼容性更好 |
| 数据获取 | 网络请求拦截 + UI事件监控 | 截图 + 图像识别 | 不依赖应用内部实现，更可靠 |
| 数据存储 | 内存缓存 + 文件存储 | 本地数据库 | 更高效的数据管理和查询 |
| 图像处理 | 无 | OpenCV + Tesseract OCR | 成熟的图像识别和OCR技术 |
| 配置管理 | JSON配置文件 | 保持现有方案 | 已有良好的配置管理基础 |
| 日志系统 | Python logging + 文件日志 | 保持现有方案 | 已有完善的日志记录机制 |

### 系统架构图（文字描述）

1. **主控制模块**：
   - 自动化流程控制器：协调整个自动化流程
   - 图像识别引擎：处理截图并识别关键信息
   - 数据管理器：处理数据存储和查询
   - 配置管理器：管理各种配置参数
   - 日志记录器：记录系统运行状态

2. **设备交互模块**：
   - ADB命令执行器：执行各种ADB命令
   - 截图管理器：获取和管理屏幕截图
   - 操作模拟器：模拟用户操作（点击、滑动等）
   - 设备状态监控器：监控设备连接状态

3. **数据处理模块**：
   - 图像预处理器：处理截图以提高识别率
   - OCR识别器：识别文本信息（价格、名称等）
   - 模板匹配器：识别界面元素和按钮
   - 数据验证器：验证识别结果的准确性

### 数据流程图（文字描述）

1. **数据采集流程**：
   ```
   启动自动化 → 截取屏幕 → 图像预处理 → 元素识别 → 数据提取 → 数据验证 → 本地存储
   ```

2. **操作控制流程**：
   ```
   分析界面 → 识别目标 → 计算位置 → 模拟操作 → 等待响应 → 验证结果 → 记录日志
   ```

3. **错误处理流程**：
   ```
   检测异常 → 分析原因 → 尝试恢复 → 记录错误 → 更新状态 → 继续/终止流程
   ```

## 代码复用分析

### 可复用模块清单

| 模块名称 | 文件路径 | 复用程度 | 复用方式 |
|---------|---------|---------|---------|
| 配置管理器 | utils/config_manager.py | 95% | 直接复用，仅需少量调整 |
| 日志记录器 | utils/logger.py | 90% | 直接复用，可能需要调整日志格式 |
| 设备管理器 | utils/device_manager.py | 70% | 部分复用，需要增强ADB功能 |
| 主控制脚本 | main.py | 60% | 结构复用，需要重写核心逻辑 |
| 市场配置 | config/market_config.json | 85% | 直接复用，可能需要调整参数 |
| 依赖包管理 | requirements.txt | 50% | 部分复用，需要添加图像处理库 |

### 需要重构模块清单

| 模块名称 | 原文件路径 | 新文件路径 | 重构原因 |
|---------|-----------|-----------|---------|
| Frida管理器 | utils/frida_manager.py | utils/automation_manager.py | 替换Frida为按键精灵/ADB控制 |
| Lua管理器 | utils/lua_manager.py | utils/image_processor.py | 替换Lua脚本为图像识别处理 |
| Frida Hook脚本 | scripts/market_hook.js | 无 | 不再需要Hook脚本 |
| Lua自动化脚本 | scripts/market_automation.lua | scripts/automation_templates.py | 转换为Python模板文件 |
| Frida配置 | config/frida_config.json | config/automation_config.json | 替换为自动化控制配置 |

### 新增开发模块清单

| 模块名称 | 文件路径 | 主要功能 | 开发优先级 |
|---------|---------|---------|-----------|
| 截图管理器 | utils/screenshot_manager.py | 屏幕截图获取和管理 | 高 |
| 图像识别器 | utils/image_recognizer.py | 图像识别和OCR处理 | 高 |
| 操作模拟器 | utils/action_simulator.py | 用户操作模拟 | 高 |
| 模板管理器 | utils/template_manager.py | 界面模板管理 | 中 |
| 数据验证器 | utils/data_validator.py | 数据准确性验证 | 中 |
| 错误恢复器 | utils/error_recovery.py | 异常处理和恢复 | 中 |

### 复用程度评估表

| 系统组件 | 复用比例 | 复用价值 | 重构成本 | 综合评估 |
|---------|---------|---------|---------|---------|
| 配置管理系统 | 95% | 高 | 低 | 优秀 |
| 日志记录系统 | 90% | 高 | 低 | 优秀 |
| 设备连接管理 | 70% | 中 | 中 | 良好 |
| 主控制框架 | 60% | 高 | 高 | 良好 |
| 数据存储结构 | 85% | 高 | 低 | 优秀 |
| 错误处理机制 | 75% | 中 | 中 | 良好 |
| 用户界面 | 30% | 低 | 高 | 一般 |

## 实施计划

### 开发阶段划分

**第一阶段：基础架构搭建（预计2周）**
- 搭建新的项目结构
- 实现基础的ADB控制功能
- 开发截图获取模块
- 迁移配置管理系统

**第二阶段：核心功能开发（预计3周）**
- 开发图像识别和OCR功能
- 实现操作模拟功能
- 开发数据验证机制
- 集成错误处理系统

**第三阶段：系统集成测试（预计2周）**
- 集成所有模块
- 进行全面测试
- 性能优化
- 文档编写

**第四阶段：部署和优化（预计1周）**
- 生产环境部署
- 监控系统搭建
- 用户培训
- 问题修复

### 各阶段目标和交付物

**第一阶段：基础架构搭建**
- 目标：建立新系统的基础框架
- 交付物：
  - 新的项目结构
  - ADB控制模块
  - 截图管理模块
  - 基础配置系统

**第二阶段：核心功能开发**
- 目标：实现核心自动化功能
- 交付物：
  - 图像识别模块
  - 操作模拟模块
  - 数据验证模块
  - 错误处理系统

**第三阶段：系统集成测试**
- 目标：确保系统稳定可靠
- 交付物：
  - 完整集成系统
  - 测试报告
  - 性能优化报告
  - 用户手册

**第四阶段：部署和优化**
- 目标：系统正式上线运行
- 交付物：
  - 生产环境系统
  - 监控系统
  - 培训材料
  - 维护文档

### 时间规划

| 阶段 | 开始时间 | 结束时间 | 持续时间 | 关键里程碑 |
|------|---------|---------|---------|-----------|
| 第一阶段 | 第1周 | 第2周 | 2周 | 基础架构完成 |
| 第二阶段 | 第3周 | 第5周 | 3周 | 核心功能完成 |
| 第三阶段 | 第6周 | 第7周 | 2周 | 系统测试完成 |
| 第四阶段 | 第8周 | 第8周 | 1周 | 系统正式上线 |

### 里程碑设置

1. **M1：基础架构完成**（第2周末）
   - 新项目结构搭建完成
   - ADB基础功能可用
   - 截图功能正常工作

2. **M2：核心功能完成**（第5周末）
   - 图像识别功能可用
   - 操作模拟功能正常
   - 基本自动化流程可运行

3. **M3：系统测试完成**（第7周末）
   - 所有功能集成完成
   - 测试用例全部通过
   - 性能指标达到要求

4. **M4：系统正式上线**（第8周末）
   - 生产环境部署完成
   - 监控系统正常运行
   - 用户培训完成

## 风险评估

### 技术风险及应对措施

| 风险项 | 风险等级 | 影响描述 | 应对措施 | 负责人 |
|-------|---------|---------|---------|--------|
| 图像识别准确率不足 | 高 | 导致数据采集错误 | 多种识别算法结合，持续优化模板 | 技术团队 |
| ADB连接不稳定 | 中 | 影响自动化流程稳定性 | 实现连接重试机制，监控连接状态 | 技术团队 |
| 应用界面更新 | 中 | 导致模板失效 | 建立模板更新机制，多版本兼容 | 技术团队 |
| 性能瓶颈 | 中 | 影响处理效率 | 优化算法，增加并发处理 | 技术团队 |
| 设备兼容性问题 | 低 | 限制使用范围 | 支持多种设备，提供兼容性检查 | 测试团队 |

### 项目风险及缓解方案

| 风险项 | 风险等级 | 影响描述 | 缓解方案 | 负责人 |
|-------|---------|---------|---------|--------|
| 进度延期 | 中 | 影响项目交付 | 增加资源投入，调整优先级 | 项目经理 |
| 需求变更 | 中 | 影响开发计划 | 建立变更控制流程，评估影响 | 产品经理 |
| 人员流失 | 低 | 影响项目连续性 | 知识文档化，交叉培训 | HR部门 |
| 质量问题 | 中 | 影响系统稳定性 | 加强测试，代码审查 | 质量团队 |
| 用户接受度 | 低 | 影响推广效果 | 早期用户参与，持续收集反馈 | 产品团队 |

### 质量保证措施

1. **代码质量保证**：
   - 实施代码审查制度
   - 使用静态代码分析工具
   - 建立编码规范和最佳实践
   - 定期进行重构和优化

2. **测试质量保证**：
   - 建立完善的测试用例
   - 实施自动化测试
   - 进行性能测试和压力测试
   - 建立持续集成流程

3. **文档质量保证**：
   - 维护完整的技术文档
   - 提供详细的用户手册
   - 建立知识库和FAQ
   - 定期更新文档内容

## 资源需求

### 开发资源需求

| 角色 | 人数 | 技能要求 | 参与阶段 | 主要职责 |
|------|------|---------|---------|---------|
| 项目经理 | 1 | 项目管理经验 | 全程 | 项目协调、进度管理 |
| Python开发工程师 | 2 | Python、ADB、图像处理 | 全程 | 核心功能开发 |
| 测试工程师 | 1 | 自动化测试、性能测试 | 阶段3-4 | 测试用例设计、执行 |
| 图像算法工程师 | 1 | OpenCV、OCR、机器学习 | 阶段2 | 图像识别算法开发 |
| 技术文档工程师 | 1 | 技术写作能力 | 阶段3-4 | 文档编写、维护 |

### 测试资源需求

| 资源类型 | 数量 | 配置要求 | 用途 |
|---------|------|---------|------|
| 测试设备 | 3-5台 | Android 10+，不同品牌 | 兼容性测试 |
| 测试服务器 | 1台 | 4核CPU，8GB内存 | 自动化测试环境 |
| 测试数据 | 多套 | 不同场景的截图和配置 | 功能测试 |
| 测试工具 | 多套 | ADB、图像识别工具 | 辅助测试 |

### 硬件环境需求

| 硬件类型 | 最低配置 | 推荐配置 | 用途 |
|---------|---------|---------|------|
| 开发机器 | 8核CPU，16GB内存 | 16核CPU，32GB内存 | 开发环境 |
| 测试设备 | Android 10+，4GB内存 | Android 12+，8GB内存 | 测试环境 |
| 存储设备 | 500GB SSD | 1TB SSD | 数据存储 |
| 网络设备 | 100Mbps | 1Gbps | 网络连接 |

## 项目管理

### 开发方法论

采用**敏捷开发方法**，结合**迭代式开发**模式：

1. **Sprint规划**：
   - 每2周为一个Sprint周期
   - 每个Sprint开始前进行规划会议
   - 明确Sprint目标和交付物

2. **每日站会**：
   - 每天进行15分钟站会
   - 汇报进度、问题和计划
   - 及时解决阻塞问题

3. **Sprint评审**：
   - 每个Sprint结束时进行评审
   - 演示完成的功能
   - 收集反馈和改进建议

4. **回顾会议**：
   - 分析Sprint中的问题和成功经验
   - 制定改进措施
   - 持续优化开发流程

### 质量控制流程

1. **需求评审**：
   - 需求文档完整性检查
   - 技术可行性评估
   - 风险分析和应对措施

2. **设计评审**：
   - 架构设计合理性评估
   - 接口设计标准化检查
   - 性能和安全性考虑

3. **代码评审**：
   - 代码规范符合性检查
   - 逻辑正确性验证
   - 性能和安全性评估

4. **测试评审**：
   - 测试用例覆盖率检查
   - 测试结果有效性验证
   - 缺陷修复质量确认

### 进度监控机制

1. **进度跟踪**：
   - 使用项目管理工具跟踪任务进度
   - 定期更新进度报告
   - 及时识别和解决延期风险

2. **质量监控**：
   - 建立质量指标体系
   - 定期进行质量评估
   - 持续改进质量水平

3. **风险监控**：
   - 建立风险识别机制
   - 定期评估风险等级
   - 及时启动应对措施

4. **沟通机制**：
   - 建立定期沟通机制
   - 确保信息及时传递
   - 快速解决协调问题

## 附录

### 术语表

| 术语 | 解释 |
|------|------|
| ADB | Android Debug Bridge，Android调试桥 |
| OCR | Optical Character Recognition，光学字符识别 |
| OpenCV | 开源计算机视觉库 |
| Frida | 动态代码插桩工具 |
| 按键精灵 | 自动化脚本工具 |
| Sprint | 敏捷开发中的迭代周期 |

### 参考文档

1. 现有项目架构文档
2. Android开发指南
3. OpenCV官方文档
4. ADB命令参考手册
5. 敏捷开发最佳实践

### 联系信息

| 角色 | 姓名 | 联系方式 |
|------|------|---------|
| 项目经理 | 待定 | 待定 |
| 技术负责人 | 待定 | 待定 |
| 测试负责人 | 待定 | 待定 |

---

*本文档版本：1.0*  
*最后更新日期：2025-11-21*  
*文档状态：初稿*